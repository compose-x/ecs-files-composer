{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "typeName": "input",
    "description": "Configuration input definition for ECS Files Composer",
    "required": [
        "files"
    ],
    "properties": {
        "files": {
            "type": "object",
            "uniqueItems": true,
            "patternProperties": {
                "^/[\\x00-\\x7F]+$": {
                    "$ref": "#/definitions/FileDef"
                }
            }
        },
        "IamOverride": {
            "type": "object",
            "$ref": "#/definitions/IamOverrideDef"
        }
    },
    "definitions": {
        "FileDef": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "path": {
                    "type": "string"
                },
                "content": {
                    "type": "string",
                    "description": "The raw content of the file to use"
                },
                "source": {
                    "$ref": "#/definitions/SourceDef"
                },
                "encoding": {
                    "type": "string",
                    "enum": [
                        "base64",
                        "plain"
                    ],
                    "default": "plain"
                },
                "group": {
                    "type": "string",
                    "description": "UNIX group name or GID owner of the file. Default to root(0)",
                    "default": "root"
                },
                "owner": {
                    "type": "string",
                    "description": "UNIX user or UID owner of the file. Default to root(0)",
                    "default": "root"
                },
                "mode": {
                    "type": "string",
                    "description": "UNIX file mode",
                    "default": "0644"
                },
                "context": {
                    "type": "string",
                    "enum": [
                        "plain",
                        "jinja2"
                    ],
                    "default": "plain"
                },
                "ignore_if_failed": {
                    "type": "boolean",
                    "description": "Whether or not the failure to retrieve the file should stop the execution",
                    "default": false
                },
                "commands": {
                    "type": "object",
                    "properties": {
                        "post": {
                            "$ref": "#/definitions/CommandsDef",
                            "description": "Commands to run after the file was retrieved"
                        },
                        "pre": {
                            "$ref": "#/definitions/CommandsDef",
                            "description": "Commands executed prior to the file being fetched, after `depends_on` completed"
                        }
                    }
                }
            }
        },
        "SourceDef": {
            "type": "object",
            "properties": {
                "Url": {
                    "$ref": "#/definitions/UrlDef"
                },
                "Ssm": {
                    "$ref": "#/definitions/SsmDef"
                },
                "S3": {
                    "$ref": "#/definitions/S3Def"
                },
                "Secret": {
                    "$ref": "#/definitions/SecretDef"
                }
            }
        },
        "UrlDef": {
            "type": "object",
            "properties": {
                "Url": {
                    "type": "string",
                    "format": "uri"
                },
                "Username": {
                    "type": "string"
                },
                "Password": {
                    "type": "string"
                }
            }
        },
        "SsmDef": {
            "type": "object",
            "properties": {
                "ParameterName": {
                    "type": "string"
                },
                "IamOverride": {
                    "$ref": "#/definitions/IamOverrideDef"
                }
            }
        },
        "SecretDef": {
            "type": "object",
            "required": [
                "SecretId"
            ],
            "properties": {
                "SecretId": {
                    "type": "string"
                },
                "VersionId": {
                    "type": "string"
                },
                "VersionStage": {
                    "type": "string"
                },
                "IamOverride": {
                    "$ref": "#/definitions/IamOverrideDef"
                }
            }
        },
        "S3Def": {
            "type": "object",
            "required": [
                "BucketName",
                "Key"
            ],
            "properties": {
                "BucketName": {
                    "type": "string",
                    "description": "Name of the S3 Bucket"
                },
                "BucketRegion": {
                    "type": "string",
                    "description": "S3 Region to use. Default will ignore or retrieve via s3:GetBucketLocation"
                },
                "Key": {
                    "type": "string",
                    "description": "Full path to the file to retrieve"
                },
                "IamOverride": {
                    "$ref": "#/definitions/IamOverrideDef"
                }
            }
        },
        "IamOverrideDef": {
            "type": "object",
            "description": "When source points to AWS, allows to indicate if another role should be used",
            "properties": {
                "RoleArn": {
                    "type": "string"
                },
                "SessionName": {
                    "type": "string",
                    "default": "S3File@EcsConfigComposer",
                    "description": "Name of the IAM session"
                },
                "ExternalId": {
                    "type": "string",
                    "description": "The External ID to use when using sts:AssumeRole"
                },
                "RegionName": {
                    "type": "string"
                }
            }
        },
        "CommandsDef": {
            "type": "array",
            "description": "List of commands to run",
            "items": {
                "type": "string",
                "description": "Shell command to run"
            }
        }
    }
}
